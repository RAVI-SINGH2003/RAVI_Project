RAVI project is a web based automated tool to convert PDF file into an accessible HTML format. Steps to setup the project
1. Compile code with following command
   ```
   npm run build
   ```
   If any isue is encountered please log the issue.
   Try to install missing modules with 
   ```
   npm install
   ```
   
2. Run the server with 
   ```
   node scripts/server.js
   ```
   Run docker server with following commands.
   Run the container 
   ```
   sudo docker start -i container_ID
   ```
   Run server with following command 
   ```
   python3 server.py
   ```
   
3. In the web browser
   ```
   `http://127.0.0.1:8000/`   ( NOTE: Do not use http://localhost:8000/ )
   ```



# Setup
## Node.js Setup
```bash
sudo apt install nodejs
sudo apt install npm
```

## PDF2HTMLEx setup for converting PDF to fixed layout HTML
Upto Ubuntu 16
```bash
sudo apt install pdf2htmlEx
```
For later get the appropriate binary for your OS from [here](https://github.com/pdf2htmlEX/pdf2htmlEX/wiki/Download) and install
```
sudo apt install ./pdf2htmlEX-0.18.8.rc1-master-20200630-Ubuntu-focal-x86_64.deb
```

## Font Extraction Tools for extracting font and character names from embedded font files
```bash
apt install fonttools
apt install texlive-binaries
```
We use `ttx` from fonttools for conversion of ttf to xml and `ttf2afm` from texlive-binaries for conversion of well, ttf to afm.

## MaxTract setup for conversion of Math to LaTeX
```
git clone https://github.com/assistech-iitdelhi/MaxTract.git
cd MaxTract/
sudo apt install ocaml
sudo apt install ocaml-findlib
sudo apt install libocamlnet-ocaml-dev
tar -xvf json-wheel-1.0.6.tar 
cd json-wheel-1.0.6/
make
make install
cd ..
cd src/linearize
make
```
In case of errors related to prohibited string modifications during compilation of json-wheel, edit the makefile to use `-unsafe-string` option. See note about the change in OCaml [here](https://caml.inria.fr/pub/docs/manual-ocaml/libref/String.html). Add `MaxTract/src/` and `MaxTract/` to appropriate path variable so `linearizer` and `anderson_post.opt` are visible to server programs. If you see `Illegal seek` errors see suggestions [here](https://stackoverflow.com/questions/64876025/no-source-file-for-netaccel-link-error-on-running-program).


## PDF2CHARINFO
```bash
git clone https://github.com/zorkow/pdf2charinfo.git
cd pdf2charinfo/
npx webpack
```
In case of errors launching chrome see the [troubleshooting guide](https://github.com/puppeteer/puppeteer/blob/main/docs/troubleshooting.md)

## Docker for mathematics detection
   For downloading docker image please pull it with following command.
   ```
   sudo docker pull sanjeev97/math_detect:0.1
   ```
   This image can be checked with 
   ```
   sudo docker image ls
   ```
   Check container ID with 
   ```
   sudo docker ps -a
   ```

# Running 
## From the Browser
1. First convert the PDF to Fixed Layout HTML. Make sure you have compiled your code as the following scripts derives paths by looking up the compile destination folder.
```bash
scripts/pdf2html_doc.sh samples/ncert.nic.in/jemh1/jemh1ps/jemh1ps.pdf
```

2. Now visit [http://localhost:8000/samples/ncert.nic.in/jemh1/jemh1ps/jemh1ps.html](http://localhost:8000/samples/ncert.nic.in/jemh1/jemh1ps/jemh1ps.html) and in the console type
```javascript
let d = new pdf2charinfo.document(doc)
d.matchSpans()
d.backgroundAnalysis()
d.tableAnalysis()
d.linify()
```

## From the Commandline
1. First convert the PDF to Fixed Layout HTML
```bash
scripts/pdf2html_doc.sh samples/ncert.nic.in/jemh1/jemh1ps/jemh1ps.pdf
```
2. Now run `scripts/run_puppeteer.js http://localhost:8000/samples/ncert.nic.in/jemh1/jemh1ps/jemh1ps.html`

## To Run the Web Interface to the Commandline
```bash
node scripts/server.js 
```
1. Visit [http://localhost:8000/](http://127.0.0.1:8000)
2. Upload the PDF and Submit

# Behind the Scenes

## Create pages with external font files

This is necessary to generate the correct symbol information via the `.afm` files.

```bash
pdf2htmlEX --split-pages 1 --embed-font 0 --font-format ttf file
```

## Create pages with embedded woff

This is necessary for the bounding box analysis, as the `foreignObject` tag can not load external sources.

```bash
pdf2htmlEX --split-pages 1 --embed-font 1 --font-format woff --dest-dir out file
```
# Running `pdf2html_pages.sh`

This generates html files from pdf and generates font information. You will need `fonttools` and `ttf2afm` (from texlive-binaries) to run this.

## Running `pdf2charinfo` in the page

```JavaScript
let page = new pdf2charinfo.page(document);
page.backgroundAnalysis()
page.matchSpans([X, Y])
```
The `[X,Y]` interval is optional and gives the span ids from where they should be processed.

## Things removed from the html file generated by pdf2htmlEx:

* JavaScript at the bottom
* Fancy styles: Removes the page layout style.
* #sidebar and #page-container stuff, everything up to .loading-indicator.

* We could potentially remove every class that is not used.

## Font transformations

### Get Woff

* Get base64 encoding from the html

Example:

* ff0: get the data:application/font-woff part

* Translate base64 into woff URL https://www.opinionatedgeek.com/codecs/base64decoder
* Alternatively, use the command line base64 program:
```bash
base64 -d ff0 > ff0.woff
```
  
* Only translate the part after base64,

* That should give you a binary file with a header woff.

### Get ttf

* translate woff into ttf 
* Converter at URL https://andrewsun.com/tools/woffer-woff-font-converter/
* Possibly use https://github.com/as-com/woffjs
* Alternatively:
  Python:  https://github.com/hanikesn/woff2otf
  JS: https://github.com/arty-name/woff2otf

* Thus we get ff0.ttf

### Get font metric:

* ttf2tfm ff0.ttf 

### Get font name:

* ttf2afm ff0.ttf > ff0.afm

  Find the original font metric file and look up the position of the characters
  in there. That will give us the actual character name.


# OLD Notes
* Get base64 encoding from the html
* Translate base64 into woff URL https://www.opinionatedgeek.com/codecs/base64decoder
* translate woff into ttf URL https://andrewsun.com/tools/woffer-woff-font-converter/
* ttf2tfm font.ttf 
* let w_H be width from HTML
  let w_T be width from ttf
  ratio r = w_T/w_H

* h_H = h_T / r = |ury - lly|

* Look at https://github.com/opentypejs/opentype.js

# Convert to image to find bounding boxes!

# Table Analysis
There are three algorithms for table testing.
* Algorithm-1 => Structured Tables
* Algorithm-2 => Tables with boundary only
* Algorithm-3 => Boundary Less Tables

Each algorithm has its separate function( algo1, algo2 and algo3). On calling a function, suppose algo1 - all the structured tables in the page are identified and 
html for each is formed.

print_algo() is a function which takes as parameter a list of tables. It is used to 
print the structure of each table in the list. It also draws the boundaries of each cell on the canvas.

Finally table_analysis() is a function which is a combine of both algo1 and algo2. It runs both algo1 and algo2 on the page and then if there are some tables which both identifies then it takes the one with a better structure. In short this function runs takes into account both bordered and properly structured tables. It updates two lists - final_list_1 for algo1 and final_list_2 for algo2. 
